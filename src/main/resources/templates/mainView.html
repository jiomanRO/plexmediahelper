<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
<!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->

<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>-->



</head>
<body>
<div class="container mt-0">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="btn-group" role="group">
            <!-- Trigger Button (opens the modal) -->
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                Remove all links
            </button>

            <!-- Modal -->
            <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to remove <strong>all links</strong>? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            <!-- Actual form submission only happens if user confirms -->
                            <form th:action="@{/deleteAllLinks}" method="post">
                                <button type="submit" class="btn btn-danger">Yes, remove all</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trigger Button -->
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#confirmCreateModal">
                Create All Movies and TVShows links
            </button>

            <!-- Modal -->
            <div class="modal fade" id="confirmCreateModal" tabindex="-1" aria-labelledby="confirmCreateLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-success">
                        <div class="modal-header bg-success text-dark">
                            <h5 class="modal-title" id="confirmCreateLabel">Confirm Creation</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to <strong>create links</strong> for all Movies and TV Shows?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            <!-- Actual create form submission -->
                            <form th:action="@{/createLinks}" method="post">
                                <button type="submit" class="btn btn-success">Yes, create all</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trigger Button -->
            <button type="button" class="btn btn-outline-secondary" onclick="handleCreateMissingClick()">
                Create Missing Movies and TVShows links
            </button>

            <!-- Modal 1: Confirm Creation -->
            <div class="modal fade" id="confirmCreateMissingModal" tabindex="-1" aria-labelledby="confirmCreateMissingLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-success">
                        <div class="modal-header bg-success text-dark">
                            <h5 class="modal-title" id="confirmCreateMissingLabel">Confirm Creation</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            There are <strong><span th:text="${missingLinksCount}"></span></strong> missing links.
                            <br>Are you sure you want to <strong>create missing links</strong> for Movies and TV Shows?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            <!-- Actual create form submission -->
                            <form th:action="@{/createMissingLinks}" method="post">
                                <button type="submit" class="btn btn-success">Yes, create</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal 2: No Missing Links -->
            <div class="modal fade" id="noMissingLinksModal" tabindex="-1" aria-labelledby="noMissingLinksLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-secondary">
                        <div class="modal-header bg-secondary text-white">
                            <h5 class="modal-title" id="noMissingLinksLabel">Info</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            No missing links, nothing to create.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trigger Button -->
            <button type="button" class="btn btn-outline-danger" onclick="handleDeleteInvalidClick()">
                Delete invalid links
            </button>

            <!-- Modal -->
            <div class="modal fade" id="deleteInvalidLinksModal" tabindex="-1" aria-labelledby="confirmDeleteInvalidLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger">
                        <div class="modal-header bg-danger text-dark">
                            <h5 class="modal-title" id="confirmDeleteInvalidLabel">Confirm Deletion</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            There are <strong><span th:text="${invalidLinksCount}"></span></strong> invalid/broken links.
                            <br>Are you sure you want to <strong>delete invalid links</strong> for Movies and TV Shows?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            <!-- Actual create form submission -->
                            <form th:action="@{/deleteInvalidLinks}" method="post">
                                <button type="submit" class="btn btn-danger">Yes, delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- No Invalid Links Modal -->
            <div class="modal fade" id="noInvalidLinksModal" tabindex="-1" aria-labelledby="noInvalidLinksLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-secondary">
                        <div class="modal-header bg-secondary text-white">
                            <h5 class="modal-title" id="noInvalidLinksLabel">Info</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            No invalid links, nothing to delete.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">Items in NAS folder</h6>
            <h6><span class="fw-bold" style="color: white" th:text="${NASFolder}"></span></h6>
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-success me-2">Total: <span th:text="${totalItems}">0</span></span>
                    <span class="badge bg-success me-2">TVShows: <span th:text="${tvShowItems}">0</span></span>
                    <span class="badge bg-success me-2">Movies: <span th:text="${movieItems}">0</span></span>
                    <span class="badge bg-success me-2">Other: <span th:text="${otherItems}">0</span></span>
                </div>
                <div>
                    <span class="badge bg-success me-2">Links in tvshows_links folder: <span th:text="${tvShowsLinksCount}">0</span></span>
                    <span class="badge bg-success me-2">Links in movies_links folder: <span th:text="${moviesLinksCount}">0</span></span>
                    <span class="badge bg-success me-2">Links in kids_links folder: <span th:text="${kidsLinksCount}">0</span></span>
                    <span id="missingLabel" class="badge bg-success me-2" data-bs-toggle="tooltip" data-bs-placement="top"
                          title="Click to filter items with status 'Missing'"> Missing: <span th:text="${missingLinksCount}">0</span>
                    </span>
                    <span class="badge bg-success me-2">Invalid: <span th:text="${invalidLinksCount}">0</span></span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <table id="itemsTable" class="table table-striped table-bordered display" style="width:100%">
                <thead>
                <tr>
                    <th>Select</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>ContentType</th>
                    <th>Genre</th>
                    <th>Link Status</th>
                </tr>
                </thead>
                <tbody>
                <!-- Loop through the items and populate the table -->
                <tr th:each="item : ${items}">
                    <td><input type="checkbox" class="select-row"></td>
                    <td th:text="${item.getName().substring(item.getName().lastIndexOf('/') + 1)}"></td>
                    <td th:text="${item.getType()}"></td>
                    <td th:text="${item.getContentType()}"></td>
                    <td th:text="${item.getGenre()}"></td>
                    <td th:text="${item.getStatus()}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    $(function () {
        // Initialize DataTable
        //console.log("Page fully loaded");
        //console.log("Initializing DataTables...");
        const table = $('#itemsTable').DataTable({
            responsive: true,
            createdRow: function (row, data, dataIndex) {
                const status = data[5]; // Index of "Status" column

                if (status === 'Not needed') {
                    $(row).addClass('table-secondary'); // gray
                } else if (status === 'Present') {
                    $(row).addClass('table-success'); // green
                } else if (status === 'Missing') {
                    $(row).addClass('table-danger'); // red
                }
            }
        });

        // Select/Deselect rows when checkbox is clicked
        $('#itemsTable tbody').on('click', 'input.select-row', function () {
            const row = $(this).closest('tr');  // Get the row that was clicked
            if (this.checked) {
                row.addClass('selected');  // Highlight the row if selected
            } else {
                row.removeClass('selected');  // Remove highlight if deselected
            }
        });

        // Get the selected rows when the button is clicked
        $('#getSelected').on('click', function () {
            const selectedRows = [];
            $('#itemsTable tbody tr.selected').each(function () {
                const rowData = table.row(this).data();  // Get row data using DataTables API
                selectedRows.push({
                    id: rowData[1],  // The second column contains the item ID
                    item: rowData[2], // The third column contains the item name
                    description: rowData[3] // The fourth column contains the description
                });
            });

            if (selectedRows.length > 0) {
                let selectedText = selectedRows.map(row =>
                    `ID: ${row.id}, Item: ${row.item}, Description: ${row.description}`
                ).join('<br/>');
                $('#output').html(`<strong>Selected Rows:</strong><br/>${selectedText}`);
            } else {
                $('#output').html("No rows selected.");
            }
        });

        // Initialize Bootstrap tooltip
        var tooltipEl = document.getElementById('missingLabel');
        var tooltip = new bootstrap.Tooltip(tooltipEl);
        var toggle = false;
        $('#missingLabel').click(function() {
            if(toggle) {
                table.column(5).search('').draw();
                $('#missingLabel').css('font-weight', 'normal');
                toggle = false;
                $(this).removeClass('bg-danger').addClass('bg-success');
                // Update tooltip: destroy and recreate with new title
                tooltip.dispose();
                this.setAttribute('title', "Click to filter items with status 'Missing'");
                tooltip = new bootstrap.Tooltip(this);
            } else {
                table.column(5).search('Missing').draw();
                $('#missingLabel').css('font-weight', 'bold');
                toggle = true;
                $(this).removeClass('bg-success').addClass('bg-danger');
                // Update tooltip
                tooltip.dispose();
                this.setAttribute('title', "Click to remove the 'Missing' filter");
                tooltip = new bootstrap.Tooltip(this);
            }
        });

    });
</script>

<script th:inline="javascript">
    const missingLinksCount = [[${missingLinksCount}]];
    const invalidLinksCount = [[${invalidLinksCount}]];
    // Suppose missingLinks variable is provided from backend or set somewhere in JS
    // For example, let's assume it is set here (replace with your actual variable)
    //console.log("missingLinksCount:" + missingLinksCount);
    function handleCreateMissingClick() {
        if (missingLinksCount > 0) {
            // Show confirm creation modal
            const modal = new bootstrap.Modal(document.getElementById('confirmCreateMissingModal'));
            modal.show();
        } else {
            // Show no missing links modal
            const modal = new bootstrap.Modal(document.getElementById('noMissingLinksModal'));
            modal.show();
        }
    }
    function handleDeleteInvalidClick() {
        if (invalidLinksCount > 0) {
            const modal = new bootstrap.Modal(document.getElementById('deleteInvalidLinksModal'));
            modal.show();
        } else {
            const modal = new bootstrap.Modal(document.getElementById('noInvalidLinksModal'));
            modal.show();
        }
    }
</script>

</body>
</html>
